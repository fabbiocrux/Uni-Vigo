---
title: "Data Analisis"
description: |
  Data Analysis of the Mechanical data
author:
  - name: Fabio Cruz
    url: https://example.com/
    affiliation: UL
    #affiliation_url: https://example.com/spacelysprokets
date: "`r Sys.Date()`"
output:
  bookdown::html_document2: default
  bookdown::pdf_document2:
    keep_tex: true
  bookdown::word_document2:
    toc: true
    
#output: distill::distill_article
editor_options: 
  chunk_output_type: console
---

```{r setup, include= TRUE, echo=FALSE, message=FALSE}

knitr::opts_chunk$set(echo = FALSE, include = FALSE)
library(tidyverse)
library(here)
library(kableExtra)
library(ggpubr)
## Ggplot Theme setting
theme_set(theme_bw(base_size = 16, base_family = "Palatino")) 

options(digits = 4)
```

First, I look for the paths of all mechanical tests

```{r Path}
# Reading data ----
## Loading the paths

files <-
  here("Datos", "Datos ensayos") %>% 
  dir( recursive=TRUE, full.names=TRUE, pattern="\\.txt$")
```

## Phase I

Then, I read the `Phase I` tests

```{r Data.Fase.I}
# Reading the Data Fase I ----
# Selecting the Phase I
Fase.1 <- files[1:16]
## Identifying Endommage files----
  # File "PLA virgen/VE-8/VE-8.txt"

# Creating the Nested dataframe ----
Fase.I <- Fase.1 %>%  map( ~ read.delim2(.,  skip=7))
Fase.I <- Fase.I %>%   set_names(Fase.1) %>%   enframe("Type", "Data")

# Organising the dataframe
Fase.I <- 
  Fase.I %>%  
  separate(Type, 
           sep = "/",
           into = c(c(LETTERS[1:9]), c("Phase", "Material", "Sample", "Sample name"))
  ) %>% 
  select(-A, -B, -C, -D, -E, -F, -G, -H, -I)

# Arranging factors ----
Fase.I$Material <- 
  factor(Fase.I$Material,
         levels = c("PLA virgen", "PLA reciclado"),
         labels = c("Virgin" , "Recycled"))
Fase.I <- Fase.I %>% arrange(Material)


# Correcting the Tensile Strength Nov 17/2021
Fase.I$area <- c(60, 60, 60, 100, 100, 100, 100, 60, 60, 60, 60, 100, 100, 60, 100, 100) 
Fase.I$area <- Fase.I$area/100


# Adding the factor correction for each data
Fase.I <-
 Fase.I %>%
 mutate(Data = 
           map2(Data, Fase.I$area , ~ .x %>%
               mutate ( section = 32 +  ( .y * 33))
                   )
        )
 
Fase.I <-
 Fase.I %>%
 mutate(Data = 
           map(Data, ~ .x %>%
               mutate ( Tensile = (1000 * kN ) / section ,
                        Strain = mm / 28 )
                   ))


## Adding variables to the Original data
Fase.I <-
 Fase.I %>%
 mutate(Data = map(Data, ~ .x %>%
                     mutate (Tensile_old = (kN / (5 * 13))*(1000),
                                          Strain = mm / 28 )
                   ))

### Function to identify Young Modulus
Young_mod <- function(df) {
  # Filtering the Dataframe
  df <- df %>% filter(Strain >= 0.0005 & Strain <= 0.035 )
  # Doing the linear model
   model= lm(Tensile ~ Strain, data = df)
   E= coefficients(model)[[2]]
  return(E)
}
```


```{r }

# Exploratory Graphics for Young Modulus  ----

# test <-   
#    Fase.I %>% select(Sample,Material, Data)  %>% 
#    unnest(cols = c(Data))
# 
# test %>% 
#    ggplot(aes(x=Strain, y=Tensile, color= Sample)) +
#    geom_point() +
#    facet_grid( .  ~  Material ) +
#    labs(y="Tensiles strength (MPa)", x="Strain (mm/mm)") 

  
# Identifying max Tensile ----
Fase.I <- 
  Fase.I %>% 
  mutate(
         Young = map_dbl(Data,  Young_mod ),
         Load.max = map_dbl(Data,  function(df) max(df$kN)),
         Tensile.max = map_dbl(Data,  function(df) max(df$Tensile)),
         Tensile.max_old = map_dbl(Data,  function(df) max(df$Tensile_old))
         )

## Creating the experimental dataframe with the other factors ----
### Layer height 
Fase.I$LH <- c(0.15, 0.3, 0.15, 0.3, 0.3, 0.15, 0.15, 0.3, 0.15, 0.3, 0.3, 0.15, 0.3, 0.15, 0.15, 0.3) 
Fase.I$LH <- as.factor(Fase.I$LH)

### Infill Pattern 
Fase.I$IP <- c("Tri-hex", "Tri-hex", "Grid", "Grid", 
               "Tri-hex", "Tri-hex", "Grid", "Grid", 
               "Tri-hex", "Tri-hex", "Grid", "Tri-hex", 
               "Tri-hex", "Grid", "Grid", "Grid") 
Fase.I$IP <- as.factor(Fase.I$IP)


### Infill density 
Fase.I$ID <- c(60, 60, 60, 100, 100, 100, 100, 60, 60, 60, 60, 100, 100, 60, 100, 100) 
Fase.I$ID <- as.factor(Fase.I$ID)


### Printing speed 
Fase.I$PS <- c(40, 80, 80, 80, 40, 80, 40, 40, 40, 80, 40, 80, 40, 80, 40, 80 )
Fase.I$PS <- as.factor(Fase.I$PS)

# Final Dataframe
Fase.I <- Fase.I %>% select(Material, LH, IP, ID, PS, Load.max, Young, Tensile.max, Sample, `Sample name`, Data )
```



The database of `Phase I`

```{r Table.PhaseI, include=TRUE}
table.fase1 <- 
   Fase.I %>% select(Material:Load.max,Tensile.max, Young ) %>% 
   set_names("Material", "Layer Height (mm)", "Infill Pattern", "Infill Density (%)", "Printing Speed (mm/s)", "Max Load (kN)", "Tensile Strength (MPa)" ,"Young Modulus (MPa)" )

table.fase1$`Max Load (kN)` <- table.fase1$`Max Load (kN)` %>% round( digits=2)
table.fase1$`Tensile Strength (MPa)` <- table.fase1$`Tensile Strength (MPa)` %>% round( digits=2)
table.fase1$`Young Modulus (MPa)` <- table.fase1$`Young Modulus (MPa)` %>% round( digits=2)

#write_csv2(table.fase1, "tables/Phase-1.csv")

library(flextable)
table.fase1 %>% flextable() %>%
  set_caption("Results of the Phase I") %>%
  fontsize(size=8, part = "all") %>% 
#  width(j=1:3, width = c(1, 1.5, 1.5)) %>% 
  theme_zebra() 
```



### Graphic of the influence of the parameters

I create each boxplot

```{r}
## Comparing the Virgin et Recycling
MT <- 
  Fase.I %>% 
  ggplot(aes(x=Material, y = Load.max )) +
  geom_boxplot(aes(fill=Material)) +
  #facet_grid( .  ~  ) +
  labs(y="Max Load (kN)", x="Material type") +
  coord_cartesian(ylim = c(1, 4)) +
  theme(legend.position = "none") 

MT_Y <- 
Fase.I %>% 
  ggplot(aes(x=Material, y = Young )) +
  geom_boxplot(aes(fill=Material)) +
  #facet_grid( .  ~  ) +
  labs(y="Young modulus (MPa)", x="Material type") +
  coord_cartesian(ylim = c(900, 1250))+
  theme(legend.position = "none") 

MT_Tensile <- 
Fase.I %>% 
  ggplot(aes(x=Material, y = Tensile.max )) +
  geom_boxplot(aes(fill=Material)) +
  #facet_grid( .  ~  ) +
  labs(y="Tensile Strength (MPa)", x="Material type") +
  coord_cartesian(ylim = c(40, 60))+
  theme(legend.position = "none") 


## Comparing the Virgin et Recycling
LH <- 
  Fase.I %>% 
  ggplot(aes(x = LH, y = Load.max )) +
  geom_boxplot(aes(fill=Material)) +
  #facet_grid( .  ~  ) +
  labs(y="Max Load (kN)", x="Layer heigth (mm)") +
  coord_cartesian(ylim = c(1, 4)) +
  theme(legend.position = "none") 

LH_Y <- 
  Fase.I %>% 
  ggplot(aes(x = LH, y = Young )) +
  geom_boxplot(aes(fill=Material)) +
  #facet_grid( .  ~  ) +
  labs(y="Young modulus (MPa)", x="Layer heigth (mm)") +
  coord_cartesian(ylim = c(900, 1250))+
  theme(legend.position = "none") 

LH_Tensile <- 
  Fase.I %>% 
  ggplot(aes(x = LH, y = Tensile.max )) +
  geom_boxplot(aes(fill=Material)) +
  #facet_grid( .  ~  ) +
  labs(y="Tensile Strength (MPa)", x="Layer heigth (mm)") +
  coord_cartesian(ylim = c(40, 60))+
  theme(legend.position = "none") 

## Infill pattern
IP <- 
  Fase.I %>% 
  ggplot(aes(x = IP, y = Load.max )) +
  geom_boxplot(aes(fill=Material)) +
  #facet_grid( .  ~  ) +
  labs(y="Max Load (kN)", x="Infill pattern") +
  coord_cartesian(ylim = c(1, 4))

IP_Y <- 
  Fase.I %>% 
  ggplot(aes(x = IP, y = Young )) +
  geom_boxplot(aes(fill=Material)) +
  #facet_grid( .  ~  ) +
  labs(y="Young modulus (MPa)", x="Infill pattern") +
  coord_cartesian(ylim = c(900, 1250))+
  theme(legend.position = "none") 

IP_Tensile <- 
  Fase.I %>% 
  ggplot(aes(x = IP, y = Tensile.max )) +
  geom_boxplot(aes(fill=Material)) +
  #facet_grid( .  ~  ) +
  labs(y="Tensile Strength (MPa)", x="Infill pattern") +
  coord_cartesian(ylim = c(40, 60))+
  theme(legend.position = "none") 


## Infill density
ID <- 
  Fase.I %>% 
  ggplot(aes(x = ID, y = Load.max )) +
  geom_boxplot(aes(fill=Material)) +
  #facet_grid( .  ~  ) +
  labs(y="Max Load (kN)", x="Infill density (%)") +
  coord_cartesian(ylim = c(1, 4))

ID_Y <- 
  Fase.I %>% 
  ggplot(aes(x = ID, y = Young )) +
  geom_boxplot(aes(fill=Material)) +
  #facet_grid( .  ~  ) +
  labs(y="Young modulus (MPa)" , x="Infill density (%)") +
  coord_cartesian(ylim = c(900, 1250))

ID_Tensile <- 
  Fase.I %>% 
  ggplot(aes(x = ID, y = Tensile.max )) +
  geom_boxplot(aes(fill=Material)) +
  #facet_grid( .  ~  ) +
  labs(y="Tensile Strength (MPa)", x="Infill density (%)") +
  coord_cartesian(ylim = c(40, 60))

## Infill density
PS <- 
  Fase.I %>% 
  ggplot(aes(x = PS, y = Load.max )) +
  geom_boxplot(aes(fill=Material)) +
  #facet_grid( Load.max  ~ LH + IP ) +
  labs(y="Max Load (kN)", x="Printing speed (mm/s)") +
  coord_cartesian(ylim = c(1, 4))

PS_Y <- 
  Fase.I %>% 
  ggplot(aes(x = PS, y = Young )) +
  geom_boxplot(aes(fill=Material)) +
  #facet_grid( Load.max  ~ LH + IP ) +
  labs(y="Young modulus (MPa)", x="Printing speed (mm/s)") +
  coord_cartesian(ylim = c(900, 1250))
  #theme(legend.position = "none")

PS_Tensile <- 
  Fase.I %>% 
  ggplot(aes(x = PS, y = Tensile.max )) +
  geom_boxplot(aes(fill=Material)) +
  #facet_grid( Load.max  ~ LH + IP ) +
  labs(y="Tensile Strength (MPa)", x="Printing speed (mm/s)") +
  coord_cartesian(ylim = c(40, 60))
  #theme(legend.position = "none")

```


Plotting the Boxplots

```{r, fig.width=7, fig.height=7}
ggarrange(#LH, IP, ID , PS,
          LH_Tensile, IP_Tensile, ID_Tensile , PS_Tensile,
          LH_Y, IP_Y, ID_Y , PS_Y,
          ncol = 4, nrow = 2 ,common.legend = TRUE)
#ggsave("Figures/Figure-3b.jpg", width=10, height=6, dpi = "print")
```



### Anova Phase I
```{r Anova}
## Creating the Linear Model without interactions
Fase.I_anova <- Fase.I %>% select(Material:PS, Load.max)
Total_model <- lm(Load.max ~ LH+IP+ID+PS+Material , data = Fase.I_anova)
#summary(Total_model)
anv.fase.1 <- anova(Total_model)
```


```{r }
# Plotting Anovoa table
anv.fase.1 %>%  set_names("Df", "Sum Sq", "Mean Sq", "F value", "Pr(F)") %>% 
  kbl(booktabs = T, digits = c(0, 1, 3, 3, 3, 5),
      caption = "ANOVA results at 95\\% significance level",  
      linesep = "")  %>%
  kable_styling(latex_options = c("striped"))
```

### Anova Phase I - Virgin and Recycled
```{r}
## Virgin
Virgen <- Fase.I %>% filter(Material == "Virgin") %>% select(LH:PS, Load.max)
Virgin_model <- lm(Load.max ~ . , data =Virgen )
Virgin_anova <- anova(Virgin_model) 

## Recycled
Recycled <- Fase.I %>% filter(Material == "Recycled") %>% select(LH:PS, Load.max)
Recycled_model <- lm(Load.max ~ . , data =Recycled)
Recycled_anova <- anova(Recycled_model) 

```

Anova for Virgin material
```{r}
Virgin_anova %>%  set_names("Df", "Sum Sq", "Mean Sq", "F value", "Pr(F)") %>% 
  kbl(booktabs = T, digits = c(0, 1, 3, 3, 3, 5),
      caption = "ANOVA Virgin",  
      linesep = "")  %>%
  kable_styling(latex_options = c("striped"))
```

Anova for Recycled material
```{r}
Recycled_anova %>% set_names("Df", "Sum Sq", "Mean Sq", "F value", "Pr(F)") %>% 
  kbl(booktabs = T, digits = c(0, 1, 3, 3, 3, 5),
      caption = "ANOVA Recycled",  
      linesep = "")  %>%
  kable_styling(latex_options = c("striped"))
```


## Phase II
Identifying the Paths


```{r Fase.II}
# Selecting the Phase II----
Fase.2 <- files[17:27]
# Deleting test repetido Recycled 70-RE
Fase.2 <- Fase.2[-4]


# Files missing:``
# PLA reciclado/40-RE.txt

# Reading the Data Fase II ----
## Identifying missing data
Fase.II <- Fase.2 %>%  map( ~ read.delim2(.,  skip=7))
Fase.II <- Fase.II  %>%   set_names(Fase.2) %>%   enframe("Type", "Data")

# Organising datafram ----
Fase.II <- 
  Fase.II %>%  
  separate(Type, 
           sep = "/",
           into = c(c(LETTERS[1:9]), c("Phase", "Material", "Sample", "Sample name"))
  ) %>% 
  select(-A, -B, -C, -D, -E, -F, -G, -H, -I)

# Arranging factors ----
Fase.II$Material <- 
  factor(Fase.II$Material,
         levels = c("PLA virgen", "PLA reciclado"),
         labels = c("Virgin" , "Recycled"))

Fase.II <- Fase.II %>% arrange(Material)

# Correcting the Tensile Strength Nov 19/2021 -----
Fase.II$area <- rep(c(100, 40, 55, 70, 85), 2)  
Fase.II$area <- Fase.II$area/100

# Adding the factor correction for each data
Fase.II <-
 Fase.II %>%
 mutate(Data = 
           map2(Data, Fase.II$area , ~ .x %>%
               mutate ( section = 32 +  ( .y * 33))
                   )
        )
 
Fase.II <-
 Fase.II %>%
 mutate(Data = 
           map(Data, ~ .x %>%
               mutate ( Tensile = (1000 * kN ) / section ,
                        Strain = mm / 28 )
                   ))

# Calculating max Values ----
Fase.II <- 
  Fase.II %>% 
  mutate(
         Load.max = map_dbl(Data,  function(df) max(df$kN)),
         Tensile.max = map_dbl(Data,  function(df) max(df$Tensile))
         )

# Creating final dataframe of Phase II
Fase.II <- 
  Fase.II %>% 
  separate(Sample, 
           sep = "-",
           into = c("ID", "Material2")) %>% 
  select(Material, ID, Load.max, Tensile.max , area)

# As factor the the variables ID
Fase.II$ID <- as.numeric(Fase.II$ID)
```


The database of `Phase II`
```{r Table.PhaseII, include=TRUE, layout="l-body-outset"}
Fase.II %>%
  kbl(booktabs = T,
      caption = "Dataframe Phase II",  
      linesep = "")  %>%
  kable_styling()
```



```{r Table.PhaseII, include=TRUE}
table.fase2 <- 
   Fase.II %>% select(Material:Tensile.max ) %>% 
   set_names("Material", "Infill Density (%)", "Max Load (kN)", "Tensile Strength (MPa)")

table.fase1$`Max Load (kN)` <- table.fase1$`Max Load (kN)` %>% round( digits=2)
table.fase1$`Tensile Strength (MPa)` <- table.fase1$`Tensile Strength (MPa)` %>% round( digits=2)

#write_csv2(table.fase2, "tables/Phase-2.csv")


table.fase2 %>% flextable() %>%
  set_caption("Results of the Phase I") %>%
  fontsize(size=8, part = "all") %>% 
#  width(j=1:3, width = c(1, 1.5, 1.5)) %>% 
  theme_zebra() 
```

## Ploting the Graph comparative

```{r Fig.Fase.II}
A <- 
ggplot(Fase.II, aes(x=ID, y=Load.max, col=Material)) + 
  #aes(col=Material),
  geom_point( size=2 ) + 
  
  # Nov 15/2021
  geom_line(stat="smooth",
            method = "lm", formula = y ~ poly(x, 4), alpha = 0.8, size= 1) +
# stat_regline_equation(label.y = c(1,1.3), label.x = c(40,40) , data = Fase.II, aes(x=ID, y=Load.max, label = paste(..eq.label..)),  formula = y ~ poly(x, 4), inherit.aes = TRUE ) +
   
  # geom_line(data = Fase.II %>% filter(ID < 90), stat="smooth",
  #           method = "lm", formula = y ~ x, linetype ="dashed", alpha = 0.8, size= 1) +
  # geom_line(data = Fase.II %>% filter(ID > 75), stat="smooth",
  #           method = "lm", formula = y ~ poly(x, 1), linetype ="dotted", alpha = 0.8, size= 1) +
#  stat_smooth(data = Fase.II %>% filter(ID < 90) , method = "lm", formula = y ~ x, se=FALSE, aes(alpha=0.5)) +
#  stat_smooth(data = Fase.II %>% filter(ID > 65) , method = "lm", formula = y ~ x, se=FALSE) +
  #stat_smooth(method = "lm", formula = y ~ poly(x, 2), se=FALSE) +
 # stat_regline_equation(label.y = c(1,1.3), label.x = c(40,40) , data = Fase.II, aes(x=ID, y=Load.max, label = paste(..eq.label.. , ..adj.rr.label.., sep = '~\n~')),  formula = y ~ poly(x, 4), inherit.aes = TRUE ) +
  
  annotate("segment", x = 85, xend = 85, y = 1.5, yend = 3,  colour = "blue", linetype = "dashed") +
  coord_cartesian(xlim=c(40, 100), ylim=c(1, 4)) + 
  scale_x_continuous(breaks = c(40, 55, 70, 85, 100)) +
  annotate("segment", x = 40, xend = 85, y = 3.4, yend = 3.4, colour = "blue", size=0.5, alpha=0.8, arrow= arrow(ends = "both", angle = 30, length = unit(.2,"cm"))) +
  annotate("segment", x = 85, xend = 100, y = 3.5, yend = 3.5, colour = "blue", size=0.5, alpha=0.8, arrow= arrow(ends = "both", angle = 30, length = unit(.2,"cm"))) +
  # geom_vline(xintercept = 80) +
  annotate("text", x = c(50, 93), y = 3.6, label = c("Region A", "Region B"))+
  labs(title="", 
       subtitle="", 
       caption="",
       y="Maximum Load (kN)",
       x="Infill density (%)" ) +
theme(legend.position="top")
#ggsave("Correciones/Phase-2-corrected.jpg", width=5, height=5, dpi = "print")

# Calculating the reductions
Fase.II %>% group_by(ID) %>% summarise(media = mean(Load.max),                                   
                                       sde = sd(Load.max)) %>% 
  mutate(percentage = (media/3.16)*100)
#100 - (1.84 * 100)/3.16


100 - 58.1

58.1 +41.9
```


```{r}
B  <- 
ggplot(Fase.II, aes(x=ID, y=Tensile.max, col=Material)) + 
  #aes(col=Material),
  geom_point( size=2 ) + 
  
  # Nov 15/2021
  geom_line(stat="smooth",
            method = "lm", formula = y ~ poly(x, 3), alpha = 0.8, size= 1) +
# stat_regline_equation(label.y = c(1,1.3), label.x = c(40,40) , data = Fase.II, aes(x=ID, y=Load.max, label = paste(..eq.label..)),  formula = y ~ poly(x, 4), inherit.aes = TRUE ) +
   
  # geom_line(data = Fase.II %>% filter(ID < 90), stat="smooth",
  #           method = "lm", formula = y ~ x, linetype ="dashed", alpha = 0.8, size= 1) +
  # geom_line(data = Fase.II %>% filter(ID > 75), stat="smooth",
  #           method = "lm", formula = y ~ poly(x, 1), linetype ="dotted", alpha = 0.8, size= 1) +
#  stat_smooth(data = Fase.II %>% filter(ID < 90) , method = "lm", formula = y ~ x, se=FALSE, aes(alpha=0.5)) +
#  stat_smooth(data = Fase.II %>% filter(ID > 65) , method = "lm", formula = y ~ x, se=FALSE) +
  #stat_smooth(method = "lm", formula = y ~ poly(x, 2), se=FALSE) +
 # stat_regline_equation(label.y = c(1,1.3), label.x = c(40,40) , data = Fase.II, aes(x=ID, y=Load.max, label = paste(..eq.label.. , ..adj.rr.label.., sep = '~\n~')),  formula = y ~ poly(x, 4), inherit.aes = TRUE ) +
  
  annotate("segment", x = 85, xend = 85, y = 30, yend = 50,  colour = "blue", linetype = "dashed") +
  coord_cartesian(xlim=c(40, 100), ylim=c(20, 60)) + 
  scale_x_continuous(breaks = c(40, 55, 70, 85, 100)) +
  annotate("segment", x = 40, xend = 85, y = 55, yend = 55, colour = "blue", size=0.5, alpha=0.8, arrow= arrow(ends = "both", angle = 30, length = unit(.2,"cm"))) +
  annotate("segment", x = 85, xend = 100, y = 55, yend = 55, colour = "blue", size=0.5, alpha=0.8, arrow= arrow(ends = "both", angle = 30, length = unit(.2,"cm"))) +
  # geom_vline(xintercept = 80) +
  annotate("text", x = c(50, 93), y = 58, label = c("Region A", "Region B"))+
  labs(title="", 
       subtitle="", 
       caption="",
       y="Tensile Strength (MPa)",
       x="Infill density (%)" ) +
theme(legend.position="top")
#ggsave("Correciones/Phase-2-corrected.jpg", width=5, height=5, dpi = "print")

```



```{r}
ggarrange(#LH, IP, ID , PS,
          A,
          B,
          ncol = 2, nrow = 1 ,common.legend = TRUE)
#ggsave("Figures/Figure-4b.jpg", width=10, height=5, dpi = "print")
```


## Phase III

Identifying the paths
```{r Fase.III}
# Selecting the Phase III----
Fase.3 <- files[28:57]

Fase.3 <- Fase.3[1:30]


# Reading the Data Fase II ----
## Identifying missing data
Fase.III <- Fase.3 %>%  map( ~ read.delim2(.,  skip=7))
Fase.III <- Fase.III  %>%   set_names(Fase.3) %>%   enframe("Type", "Data")
#Fase.III

# Organising dataframE ----
Fase.III <- 
  Fase.III %>%  
  separate(Type, 
           sep = "/",
           into = c(c(LETTERS[1:10]), c("Material", "Orientation", "Sample", "Sample name"))
  ) %>% 
  select(-A, -B, -C, -D, -E, -F, -G, -H, -I,-J)

# Arranging factors ----
Fase.III$Material <- 
  factor(Fase.III$Material,
         levels = c( "Virgen", "Reciclado"),
         labels = c( "Virgin", "Recycled" ))

Fase.III$Orientation <- tolower(Fase.III$Orientation)
Fase.III$Orientation <- 
  factor(Fase.III$Orientation,
         levels = c("horizontal", "vertical", "canto"),
         labels = c("Horizontal" , "Vertical", "Edgewise"))

# Arraning the orde
Fase.III <- Fase.III %>% arrange(Material)


# Adding the factor correction for each data
Fase.III$area <- c(0.5)

Fase.III <- 
 Fase.III %>%
 mutate(Data = 
           map2(Data, Fase.III$area , ~ .x %>%
               mutate ( section = 32 +  ( .y * 33))
                   )
        )
 
Fase.III <-
 Fase.III %>%
 mutate(Data = 
           map(Data, ~ .x %>%
               mutate ( Tensile = (1000 * kN ) / section ,
                        Strain = mm / 28 )
                   ))


# Calculating max Values ----
Fase.III <- 
  Fase.III %>% 
  mutate(
     Load.max = map_dbl(Data,  function(df) max(df$kN)),
     Tensile.max = map_dbl(Data,  function(df) max(df$Tensile))
         )

# Creating final dataframe of Phase II
Fase.III <- 
  Fase.III %>% 
  select(Material, Orientation, Load.max, Tensile.max)
```

The database of `Phase III`
```{r , include=TRUE, layout="l-body-outset"}
Fase.III %>%
  kbl(booktabs = T,
      caption = "Dataframe Phase III",  
      linesep = "")  %>%
  kable_styling()
```



```{r}
table.fase3 <- 
   Fase.III %>% select(Material:Tensile.max ) %>% 
   set_names("Material", "Orientation", "Max Load (kN)", "Tensile Strength (MPa)")

table.fase1$`Max Load (kN)` <- table.fase1$`Max Load (kN)` %>% round( digits=2)
table.fase1$`Tensile Strength (MPa)` <- table.fase1$`Tensile Strength (MPa)` %>% round( digits=2)

#write_csv2(table.fase3, "tables/Phase-3.csv")


table.fase3 %>% flextable() %>%
  set_caption("Results of the Phase I") %>%
  fontsize(size=8, part = "all") %>% 
#  width(j=1:3, width = c(1, 1.5, 1.5)) %>% 
  theme_zebra() 
```


```{r Graph.Fase.III}
# Grafica -----

#Fase.III <- 
Fase.III %>% 
  ggplot(aes(x=Orientation, y=Load.max, colour = Material, group=Material)) + 
  geom_point(size=3) +
  #aes(colour = Material) +
  stat_summary(fun = mean, geom="line") +
  stat_summary(fun = mean, geom="crossbar", width=0.5) +
  labs(title="", 
       subtitle="", 
       caption="",
       y="Maximum Load (kN)",
       x="Build orientation of the printed sample" ) +
  theme(legend.position="top") +
  coord_cartesian(ylim=c(1, 2.25)) +
  scale_y_continuous(limits = c(1, 2.25), breaks = c(1, 1.25, 1.5, 1.75, 2, 2.25))
#ggsave("Figures/Phase-3.jpg", width=5, height=5, dpi = "print")
```


```{r}
Fase.III %>% 
  ggplot(aes(x=Orientation, y=Tensile.max, colour = Material, group=Material)) + 
  geom_point(size=3) +
  #aes(colour = Material) +
  stat_summary(fun = mean, geom="line") +
  stat_summary(fun = mean, geom="crossbar", width=0.5) +
  labs(title="", 
       subtitle="", 
       caption="",
       y="Tensile Strenght (MPa)",
       x="Build orientation of the printed sample" ) +
  theme(legend.position="top") +
  coord_cartesian(ylim=c(25, 45)) 
  #scale_y_continuous(limits = c(1, 2.25), breaks = c(1, 1.25, 1.5, 1.75, 2, 2.25))
# ggsave("Figures/Phase-3.jpg", width=5, height=5, dpi = "print")
```


Reduction of the load values
```{r }
## Calculating the reduction
Reduction <- 
  Fase.III %>% 
  group_by(Material,Orientation) %>% 
  summarise( media =  mean(Tensile.max) %>% round(digits = 2)
            #sdt = sd(Tensile.max)
                     ) 

Reduction <- Reduction %>% pivot_wider(names_from = Material, values_from = media)

Reduction <- Reduction %>% mutate(reduction = round((100 - Recycled*100/Virgin ), digits = 2))

100 - (31/27)*100




Reduction <- Reduction %>% 
   mutate(reduction.intra.vir = (100 - (Virgin/max(Virgin))*100 ) )


Reduction <- Reduction %>% 
   mutate(reduction.intra.rec = ( (max(Recycled) - Recycled) /max(Recycled) )*100)

Reduction %>% 
  kbl(booktabs = T,
      caption = "Reduction of properties according to orientation",  
      linesep = "")  %>%
  kable_styling()
```



## Exporting Tables

```{r}
## Write
#write_csv2(Fase.I, "Phase-1.csv")
#write_csv2(Fase.II, "Phase-2.csv")
#write_csv2(Fase.III, "Phase-3.csv")
```
















































